import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.List;
import java.util.ListIterator;

import javax.swing.JTextArea;

import org.jdom.Document;
import org.jdom.Element;
import org.jdom.JDOMException;
import org.jdom.input.SAXBuilder;

public class ProxyThread extends Thread implements Runnable{

	private String _className;
	private File _env;
	private Process _process;
	private String _eventHeap;
	private JTextArea _bufferText;
	private File pathToIROS;
	
	public ProxyThread (String className, File env, String eventHeap){
		_className = className;
		_env = env;
		_eventHeap = eventHeap;		
		_bufferText = new JTextArea();
		//TODO The path to the iROS package should be read dynamically
		// out of the config XML file
		SAXBuilder builder = new SAXBuilder();
		File configFile = new File("configStarter.xml");
		Document docWithConfig = new Document();
        try {
			docWithConfig = builder.build(configFile);
			Element xmlFileRoot = docWithConfig.getRootElement();
			if (xmlFileRoot != null)
				pathToIROS = new File (xmlFileRoot.getChildText("iROSDir"));
        }
			catch (JDOMException e) {
			e.printStackTrace();
		} catch (IOException e) {
			System.out.println("ERROR: iROS Path not specified!");
			//e.printStackTrace();
		}
	}
	
	public void run() {
		String line;
	try {

		String cmd = "java -classpath "+ pathToIROS + _className + " " + _eventHeap;
		System.out.println(cmd);	
		_process = Runtime.getRuntime().exec(cmd, null, _env);
			BufferedReader input = 
			       new BufferedReader
			         (new InputStreamReader(_process.getInputStream()));
			     while ((line = input.readLine()) != null) {
			    	 _bufferText.append(line + " \n");
			    	 System.out.println(line);
			       }
		} catch (IOException e) {
		}
	}

	public void kill() {
		_process.destroy();
	}
	
	public void setTextArea (JTextArea textArea){
		_bufferText = textArea;
		_bufferText.setText("");
	}
}
