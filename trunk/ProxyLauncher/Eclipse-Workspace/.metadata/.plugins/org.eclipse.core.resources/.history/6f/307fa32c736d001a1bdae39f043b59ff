import java.io.*;
import java.util.*;

import org.jdom.*;
import org.jdom.input.SAXBuilder;

import javax.swing.JTree;
import javax.swing.tree.DefaultMutableTreeNode;

	public class FindProxyStarters {

	  public List<File> files = new ArrayList<File>( 1024 );
	  public List<File> proxyDirectories = new ArrayList<File> (1024);
	  private ProxyTree proxyTree = new ProxyTree();
	 // private CustomTree directoryTree;
	  private SAXBuilder builder = new SAXBuilder();
	  public FindProxyStarters (File startdir, String fileName)  
	  {
		  //This method recursively searches a starting directory for
		  // subdirectories including Event Heap proxy files
		  // These directories are in this approach indicated by
		  // an XML-file defined by the parameter "filename"
		  // The XML files are used for later purposes as comments or
		  // different start files
		  
		  Stack<File> dirs = new Stack<File>();
		  Stack<File> insertWhere = new Stack<File>();
		  
		//  directoryTree = new CustomTree();
		  
	      if ( startdir.isDirectory() ){
	    //  directoryTree.insertNode("ROOT", startdir.getName());
	      dirs.push( startdir);
	     // System.out.println("War ein Verzeichnis --> PUSH");
	      }
	      

	    while ( dirs.size() > 0 )
	    {
	      File currentDir = dirs.pop();
	      insertWhere.push(currentDir);
	      // Insert current directory as a node node into the tree
	      for ( File file : currentDir.listFiles() )
	      {
	        if ( file.isDirectory() )
	          {dirs.push( file );
	        //  directoryTree.insertNode(insertWhere.lastElement().getName(), file.getName());
	          //It is important to know where to insert the following nodes
	          insertWhere.push(file);
	          //System.out.println("Verzeichnis gepusht");
	          //System.out.println(file);
	          }
	        else
	          if ( file.getName().equals(fileName)){
	            files.add( file );
	            System.out.println("Verzeichnis hatte XML Datei");
	            // Here the XML tags should be inserted in the tree structure
	            Document docForNode = new Document();
	            try {
					docForNode = builder.build(file);
				} catch (JDOMException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				//NOTE: The XML-reading works.
				// Now a way to precheck the XML descriptions is needed.
				// That can be postponed
			
				ProxyNode newNode = new ProxyNode();
	            Element xmlFileRoot = docForNode.getRootElement();
	            newNode.setName(xmlFileRoot.getChildText("name"));
	            newNode.setKind(xmlFileRoot.getChildText("kind"));
	            newNode.setExecutableName(xmlFileRoot.getChildText("execPrefix"));
	            newNode.setproxyClass(xmlFileRoot.getChildText("proxyClass"));
	            newNode.setComment(xmlFileRoot.getChildText("comment"));
	            newNode.setPathToFile(file);
	            
	            //System.out.println(xmlFileRoot.getChildText("kind"));
	            //System.out.println(newNode.getName());
	            //Now the new node is complete, but still has to be integrated
	            // into the tree.
	            proxyTree.insertNode(newNode);
	            
	            //Maybe I can make use of the other constructor later when
	            // directly reading out the XML tags.
	            // proxyTree.insertNode(newNode);
	            //With this tree model it will also be possible to add
	            // other directories including proxies, too
	            // The tree abstracts from the actual location on the hard drive
	            // because it makes use of the XML files.
	            // For the user, only information directly concerning the
	            // proxies is relevant.
	            proxyDirectories.add(currentDir);	            
	          }
	      }
	     }
	    for ( Iterator<ProxyNode> i = proxyTree.getTreeRoot().getSuccessors().iterator(); i.hasNext();)
	    {
	    	ProxyNode temp = (ProxyNode) i.next();
	    	System.out.println("Kind found: " + temp.getKind());
	    	Iterator iii = temp.getSuccessors().iterator();
	    	/*for (Iterator<ProxyNode> i2 = temp.getSuccessors().iterator(); i2.hasNext();)
	    	{
	    		ProxyNode temp2 = (ProxyNode) i.next();
	    		System.out.println("ProxyClass found: " + temp2.getproxyClass());
	    		/*for (Iterator<ProxyNode> i3 = temp.getSuccessors().iterator(); i3.hasNext();)
	    		{
	    			ProxyNode temp3 = (ProxyNode) i2.next();
	    			System.out.println("Proxy found: " + temp3.getName());
	    		}
	    	}
	    */	
	    }
	    		
	  }
	
	  public List<File> getFoundFiles () {
		  return files;
	  }
	  
	  public List<File> getFoundDirectories () {
		  return proxyDirectories;
	  }
	  
	  public JTree getTreeStructure (){
		  DefaultMutableTreeNode root = new DefaultMutableTreeNode ("Reiny's Proxy Launcher");
		  JTree structureTree = new JTree(root);
		  DefaultMutableTreeNode node1 = new DefaultMutableTreeNode("EBENE1");
		  root.add(node1);
		  //structureTree.add(root);
		  
		  return structureTree;
	  }
	  
	  public ProxyTree getProxyTree (){
		  return proxyTree;
	  }
	}
	
	
	
	
	/*  public void print()
	  {
	    System.out.println( "Found " + files.size() + " file" +
	                         (files.size() == 1 ? "." : "s.") );

	    for ( File f : files )
	      System.out.println( f.getAbsolutePath() );
	  }
*/
	/*  private static boolean match( String s, String suffixes[] ) 
//	 In Java 5 ... möglich
	  {
	   /* for ( String suffix : suffixes )
	      if ( s.length() >= suffix.length() &&
	           //s.substring(s.length() – suffix.length(),
	                       s.length()).equalsIgnoreCase(suffix) )*/
	  //      return true;

	    //return false;
	  //}*/
	
