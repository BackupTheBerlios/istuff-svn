import java.awt.BorderLayout;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;

import javax.swing.BoxLayout;
import javax.swing.DefaultListModel;
import javax.swing.JButton;
import javax.swing.JDialog;
import javax.swing.JFileChooser;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTextField;
import javax.swing.filechooser.FileFilter;

import org.jdom.Document;
import org.jdom.Element;
import org.jdom.JDOMException;
import org.jdom.input.SAXBuilder;
import org.jdom.output.XMLOutputter;

@SuppressWarnings("serial")
public class PreferencesDialog extends JDialog {

	private DefaultListModel _proxyDirsListModel;
	private JList _proxyDirsList;
	private JTextField _irosTextField;
	private JTextField _jmdnsTextField;
	
	
	public PreferencesDialog () {
		displayAndSetPreferences();
	}
	
	public void displayAndSetPreferences () {
		// A new dialog is displayed in which the user can specify
		// the directories needed. Values from the XML file are
		// directly read and displayed.
		
		// Create an ActionListener that is responsible for browsing and
		// adding the lines into the textfields.
		
		ActionListener jarBrowser = new ActionListener() {
			public void actionPerformed(ActionEvent arg0) {
		// Open a JoptionPane
		// The different Buttons are differentiated by their action commands
		String command = arg0.getActionCommand();
		String buttonText;
		JFileChooser chooser = new JFileChooser();
		if (command.equals("Proxy Directories")){
			chooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
			buttonText = "Add Directory";
		}
		else {
			chooser.setFileSelectionMode(JFileChooser.FILES_ONLY);
			buttonText = "Choose File";
		}
		FileFilter filter = new CustomFileFilter(command);
		chooser.setAcceptAllFileFilterUsed(false);
		chooser.setFileFilter(filter);
		
		int returnVal = chooser.showDialog(null,
				buttonText);
		if (returnVal == JFileChooser.APPROVE_OPTION) {
			File fileName = chooser.getSelectedFile();
			if (command.equals("iROS.jar"))
				_irosTextField.setText(fileName.getAbsolutePath());
			else if (command.equals("jmdns.jar"))
					// textfield change
				_jmdnsTextField.setText(fileName.getAbsolutePath());
			else
				_proxyDirsListModel.addElement(fileName.getAbsoluteFile());
		}
	}
		};
		
		//Construct the dialog.
		
		JPanel preferencesFrame = new JPanel(new BorderLayout ());		
		preferencesFrame.setLayout(new BorderLayout ());
		JPanel prefPane = new JPanel ();
		prefPane.setLayout(new BoxLayout (prefPane, BoxLayout.Y_AXIS));
		prefPane.setAlignmentX(Component.CENTER_ALIGNMENT);
	
		JPanel p;
		// first row 
		prefPane.add(new JLabel ("Libraries:"));
		
		// Second row Panel construction
		p = new JPanel();
		p.add((new JLabel ("iRos Location:"))).setPreferredSize(new Dimension (120,25));
		_irosTextField = new JTextField ();
		_irosTextField.setEditable(false);
		_irosTextField.setPreferredSize(new Dimension (300,25));
		p.add(_irosTextField);
		JButton irosButton = new JButton("Browse");
		irosButton.setActionCommand("iROS.jar");
		irosButton.addActionListener(jarBrowser);
		p.add(irosButton);
		prefPane.add(p);
		
//		 Third row Panel construction (empty)
		p = new JPanel();
		p.add((new JLabel ("JmDNS Location:"))).setPreferredSize(new Dimension (120,25));
		_jmdnsTextField = new JTextField ();
		_jmdnsTextField.setEditable(false);
		_jmdnsTextField.setPreferredSize(new Dimension (300,25));
		p.add(_jmdnsTextField);
		JButton jmdnsButton = new JButton("Browse");
		jmdnsButton.setActionCommand("jmdns.jar");
		jmdnsButton.addActionListener(jarBrowser);
		p.add(jmdnsButton);
		prefPane.add(p);
		
		// Fourth row
		prefPane.add(new JLabel ());
		
		// Fith row
		prefPane.add(new JLabel ("Proxy Directories:"));
		
		// Sixth row
		p = new JPanel ();
		_proxyDirsListModel = new DefaultListModel();
		_proxyDirsList = new JList (_proxyDirsListModel);
		_proxyDirsList.setPreferredSize(new Dimension (200, 100));
		JScrollPane proxyDirsListScrollPane = new JScrollPane (_proxyDirsList);
		_proxyDirsListModel.addElement("Show me the dirs!");
		p.add(proxyDirsListScrollPane);
		prefPane.add(p);
		// Right below the list we need a button to add and
		// remove the selected Element
		p = new JPanel();
		JButton removeDirButton = new JButton ("Remove");
		removeDirButton.addActionListener(new ActionListener(){
			public void actionPerformed (ActionEvent e){
				int selectedIndex = _proxyDirsList.getSelectedIndex();
				if (selectedIndex != -1) 
					_proxyDirsListModel.removeElementAt(selectedIndex);
			}
		});
	
		JButton addDirButton = new JButton ("Add");
		addDirButton.setActionCommand("Proxy Directories");
		addDirButton.addActionListener(jarBrowser);
		
		p.add(removeDirButton);
		//p.setAlignmentX(Component.RIGHT_ALIGNMENT);
		p.add(addDirButton);
		prefPane.add(p);
		
		p = new JPanel (new BorderLayout());
		final JButton cancelButton = new JButton ("Cancel");
		cancelButton.addActionListener(new ActionListener () {
			public void actionPerformed (ActionEvent e) {
				dispose();
			}
		});
		JButton applyButton = new JButton ("Apply Settings");
		applyButton.addActionListener(new ActionListener () {
			public void actionPerformed(ActionEvent arg0) {
				// Store the values back into the config.XML file
				try {
					savePreferencesValues();
				} catch (JDOMException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				dispose();
			}
		});
		p.add( (cancelButton), BorderLayout.WEST);
		p.add( (applyButton), BorderLayout.EAST);
		
		
		// Set the textfields
		if (ConfigDataHolder.existsConfigFile()){
			_irosTextField.setText(ConfigDataHolder.getIrosLocation());
			_jmdnsTextField.setText(ConfigDataHolder.getJmdnsLocation());
		}
		
		prefPane.add(p);
		prefPane.add(new JPanel()); // Dummy Panel to increase distance to the bottom
		prefPane.doLayout();
		prefPane.updateUI();
		
		preferencesFrame.add(prefPane, BorderLayout.CENTER);
		add(preferencesFrame);
		pack();
		setVisible(true);
	}
	
	private void savePreferencesValues () throws JDOMException, IOException {
		File configFile = new File("configStarter.xml");
		// configFile.delete();  // do I first have to delete the file?
		
		try {
			//SAXBuilder builder = new SAXBuilder();
			//configDoc = builder.build(configFile);
			Element _xmlRoot = new Element ("Configuration");
			Document configDoc = new Document(_xmlRoot);
			// Now add all the settings:
			// irosLocation
			Element libraries = new Element ("Libraries");
			Element iros = new Element ("iros");
			_xmlRoot.addContent(libraries);
			_xmlRoot.getChild("Libraries").addContent(iros);
			_xmlRoot.getChild("Libraries").addContent(_irosTextField.getText());
			//Element irosLocation = new Element (_irosTextField.getText());
			//_xmlRoot.getChild("Libraries").addContent(irosLocation);

			
			// Save the file
		     XMLOutputter outputter = new XMLOutputter();
		        FileWriter writer = new FileWriter(configFile);
		        outputter.output(configDoc,writer);
		        writer.close();
		} catch (IOException e) {
		//	System.out.println("No configFile found. New file created");
			//Element root = new Element ("Configuration");
		//	Document configDoc = new Document (root);
			
			//new PreferencesDialog();
	//	}
   
		// create a file first
	}
}
	}
