import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;

import javax.swing.JTextArea;
import javax.swing.event.EventListenerList;

import org.jdom.Document;
import org.jdom.Element;
import org.jdom.JDOMException;
import org.jdom.input.SAXBuilder;

public class ProxyThread extends Thread implements Runnable {

	private String _eventHeap;
	private Process _process;
	private JTextArea _bufferText;
	private ProxyNode _proxyNodeForThread;
	private String _runCommand;
	private File _workingDirectory;
	
    // Create the a custom listener list
    protected EventListenerList _MyListenerList =
    		new EventListenerList();
	
	/*public ProxyThread(ProxyNode proxyNode, String eventHeap) {
		_proxyNodeForThread = proxyNode;
		_eventHeap = eventHeap;
		_bufferText = new JTextArea();
		_runCommand = getRunCommand();
	}
	*/
	public ProxyThread (String launchCommand, String workingDirectory) {
		_runCommand = launchCommand;
		_workingDirectory = new File (workingDirectory);
	}

	public void run() {
		String line;
		try {
			_process = Runtime.getRuntime().exec(_runCommand, null, _workingDirectory);
			System.out.println(_runCommand); 
			BufferedReader input = new BufferedReader(new InputStreamReader(
					_process.getInputStream()));
			while ((line = input.readLine()) != null) {
				_bufferText.append(line + " \n");
			}
		} catch (IOException e) {
			System.out.println("There was an error while launching the proxy: "
					+ _proxyNodeForThread.getName());
		}
		// send a message as an Event that the process has stopped
	    // This private class is used to fire MyEvents
		System.out.println("ready");
		FireActionEvent.fireEvent (new ActionEvent(this, ActionEvent.ACTION_PERFORMED, 
				"Process ended"), _MyListenerList);
	}

	public void kill() {
		_process.destroy();
	}

	public void setTextArea(JTextArea textArea) {
		_bufferText = textArea;
		_bufferText.setText("");
	}
	
	private String getRunCommand () {
		String libs = "";
		String irosPath = ConfigDataHolder.getIrosLocation();
		
		// If there are custom libraries needed for a proxy, they are in an ArrayList
		// inside the proxyNode. That "customLibraryPath" has to be constructed.
		
		// It must be differentiated between the different OS because the syntax
		// of the JAVA Compiler call is a little different.
		String separator;
		if (System.getProperty("os.name").contains("Windows"))
			separator = ";";
		else
			separator = ":";
		
		for (int i = 0; i != _proxyNodeForThread.getCustomLibs().size(); i++)
			libs = libs + _proxyNodeForThread.getCustomLibs().get(i) + separator;
			
		return ("java -classpath " + irosPath + separator + libs + ". " + _proxyNodeForThread.getClassName()
						+ " " + _eventHeap);
	}

	 
    // This methods allows classes to register for MyEvents
    public void addProcessQuitEventListener(ActionListener listener) {
        _MyListenerList.add(ActionListener.class, listener);
    }

} // end of class
