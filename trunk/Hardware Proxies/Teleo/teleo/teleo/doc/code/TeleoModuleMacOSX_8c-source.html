<html>
<head>
 
<title>TELEO APPLICATION SDK</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="code.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000" link="619ec3" vlink="619ec3" alink="619ec3">

<table width="100%" border="0" cellspacing="0" cellpadding="-1">
  <tr> 
    <td width="1%" rowspan="2" bgcolor="#FFFFFF" valign="top"><a href="/index.htm"><img src="images/logo_header_blue.jpg" width="263" height="123" border="0"></a></td>
    <td height="109" bgcolor="395e7a" width="100%" valign="bottom" align="left"> 
      <p>&nbsp;</p>
      <table width="100%" border="0">
        <tr> 
          <td width="20%" height="20" class="medium_bold"> 
            <div align="center">
              <font color="619ec3" class="medium_bold"><a href="http://www.makingthings.com/home.htm">HOME</a></font>
            </div>
          </td>
          <td width="20%" height="20" class="medium_bold"> 
            <div align="center"><font color="619ec3" class="medium_bold"><a href="http://www.makingthings.com/projects.htm">PROJECTS</a></font></div>
          </td>
          <td width="20%" height="20" class="medium_bold"> 
            <div align="center"><font color="#FFFFFF" class="medium_bold"><b class="medium_bold">PRODUCTS</b></font></div>
          </td>
          <td width="20%" class="medium_bold" height="20"> 
            <div align="center"><font color="619ec3" class="medium_bold"><a href="http://www.makingthings.com/services.htm">SERVICES</a></font></div>
          </td>
          <td width="20%" class="medium_bold" height="20"> 
            <div align="center"><font color="619ec3" class="medium_bold"><a href="http://www.makingthings.com/news/news.htm">NEWS</a></font></div>
          </td>
        </tr>
      </table>
    </td>
  </tr>
  <tr> 
    <td width="100%" height="15">&nbsp;</td>
  </tr>
  <tr align="left" valign="middle"> 
    <td colspan="2"></td>
  </tr>
</table> 
<br>
<hr>

<font face="Arial, Helvetica, sans-serif" size="2">


<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>TeleoModuleMacOSX.c</h1><a href="TeleoModuleMacOSX_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/* Copyright 2003 MakingThings LLC. */</span>
00002 
00016 <span class="preprocessor">#include "stdio.h"</span>
00017 <span class="preprocessor">#include "<a class="code" href="TeleoModule_8h.html">TeleoModule.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="TeleoModuleManager_8h.html">TeleoModuleManager.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="TeleoInterface_8h.html">TeleoInterface.h</a>"</span>
00020 
00021 <span class="comment">// for scandir</span>
00022 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00023 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
00024 
00025 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00026 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00027 
<a name="l00028"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a0">00028</a> <span class="preprocessor">#define EVENT_TIME 10</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">// Thread stuff</span>
00031 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00032 
00033 <span class="comment">// Locals                            </span>
00037 <span class="comment"></span><span class="keywordtype">void</span>* <a class="code" href="TeleoChannelTest_8c.html#a5">doTimer</a>( <span class="keywordtype">void</span>* data );
00041 <span class="keywordtype">void</span>* <a class="code" href="TeleoModuleWin32_8c.html#a8">doInput</a>( <span class="keywordtype">void</span>* data );
00042 
00043 <span class="comment">// TeleoChannel Callbacks</span>
00047 <span class="comment"></span><a class="code" href="TeleoError_8h.html#a20">TeleoError</a> <a class="code" href="TeleoChannelTest_8c.html#a6">output</a>( <a class="code" href="structTeleoChannel.html">TeleoChannel</a>* tc, uint8* c, uint8 count );
00051 <a class="code" href="TeleoError_8h.html#a20">TeleoError</a> <a class="code" href="TeleoChannelTest_8c.html#a7">timerRequest</a>( <a class="code" href="structTeleoChannel.html">TeleoChannel</a>* tc, <span class="keywordtype">bool</span> enable );
00052 
00053 <span class="comment">// TeleoChannel Device Finder</span>
00056 <span class="comment"></span><span class="keyword">static</span> <a class="code" href="TeleoError_8h.html#a20">TeleoError</a> <a class="code" href="TeleoModuleMacOSX_8c.html#a12">TI_FindUsbSerialDevice</a>(<span class="keywordtype">char</span>* dest, <span class="keywordtype">int</span> destLen);
00057 
00058 <span class="comment">// routine used to select matches in scandir</span>
00062 <span class="comment"></span><span class="keywordtype">int</span>  <a class="code" href="TeleoModuleMacOSX_8c.html#a13">matchUsbSerialDevice</a> (<span class="keyword">struct</span> dirent * thisun);
00063 
<a name="l00064"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a2">00064</a> <a class="code" href="structTeleoModuleManager.html">TeleoModuleManager</a>* <a class="code" href="TeleoModuleLinux_8c.html#a1">teleoModuleManager</a>;
<a name="l00065"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a3">00065</a> <a class="code" href="structTeleoChannel.html">TeleoChannel</a>* <a class="code" href="TeleoModuleLinux_8c.html#a2">teleoChannel</a>;
<a name="l00066"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a4">00066</a> <a class="code" href="structTeleoInterface.html">TeleoInterface</a>* <a class="code" href="TeleoModuleLinux_8c.html#a3">teleoInterface</a>;
00067 
00068 <span class="comment">// Threads</span>
<a name="l00069"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a5">00069</a> pthread_t <a class="code" href="TeleoModuleLinux_8c.html#a4">teleoInputThread</a>;
<a name="l00070"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a6">00070</a> pthread_t <a class="code" href="TeleoModuleLinux_8c.html#a5">teleoTimerThread</a>;
<a name="l00071"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a7">00071</a> pthread_mutex_t <a class="code" href="TeleoModuleLinux_8c.html#a6">teleoThreadMutex</a>;
00072 
<a name="l00073"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a1">00073</a> <span class="preprocessor">#define DEVICE_NAME_MAX_LEN 80</span>
00074 <span class="preprocessor"></span>
<a name="l00075"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a14">00075</a> <a class="code" href="TeleoError_8h.html#a20">TeleoError</a> <a class="code" href="TeleoModuleLinux_8c.html#a12">TeleoModule_Init</a>( cchar* interfaceName, TI_InterfaceType interfaceType, <a class="code" href="structTeleoModuleManager.html">TeleoModuleManager</a>** tmm )
00076 {
00077   <a class="code" href="TeleoTypes_8h.html#a3">uint8</a> c;
00078   <a class="code" href="structTeleoData.html">TeleoData</a> data;
00079   <a class="code" href="structTMM__Module.html">TMM_Module</a>* mioTest;
00080   <a class="code" href="TeleoError_8h.html#a20">TeleoError</a> teleoError;
00081   <a class="code" href="TeleoTypes_8h.html#a9">cchar</a>* channelName;
00082   <span class="keywordtype">char</span> usbSerialDeviceName[<a class="code" href="TeleoModuleMacOSX_8c.html#a1">DEVICE_NAME_MAX_LEN</a>];
00083 
00084   *tmm = NULL;
00085 
00086   <span class="comment">// Find the USB serial device</span>
00087 
00088   <span class="comment">// first prepend the path to the device directory</span>
00089   sprintf( usbSerialDeviceName, <span class="stringliteral">"%s"</span>, <span class="stringliteral">"/dev/"</span>);
00090 
00091   <span class="comment">// next find the device itself and append that</span>
00092   <span class="keywordflow">if</span> ( ( teleoError = 
00093            <a class="code" href="TeleoModuleMacOSX_8c.html#a12">TI_FindUsbSerialDevice</a>(usbSerialDeviceName+strlen(<span class="stringliteral">"/dev/"</span>), 
00094                                   DEVICE_NAME_MAX_LEN ) ) != <a class="code" href="TeleoError_8h.html#a20a0">TELEO_OK</a> )
00095   {
00096     <span class="comment">// printf("Failed to find Teleo USB Serial device\n");</span>
00097     <span class="keywordflow">return</span> teleoError;
00098   }
00099 
00100   <span class="comment">// Create the Interface</span>
00101   <span class="keywordflow">if</span> ( ( teleoError = <a class="code" href="TeleoInterfaceLinux_8c.html#a0">TI_Create</a>( usbSerialDeviceName, 
00102       interfaceType, 
00103       &amp;teleoInterface ) ) != <a class="code" href="TeleoError_8h.html#a20a0">TELEO_OK</a> )
00104        <span class="keywordflow">return</span> teleoError;
00105   <a class="code" href="TeleoInterfaceLinux_8c.html#a4">TI_blockingSet</a>( teleoInterface, <span class="keyword">true</span> );
00106   <a class="code" href="TeleoInterfaceLinux_8c.html#a3">TI_typeGet</a>(teleoInterface, &amp;channelName );
00107   <a class="code" href="TeleoInterfaceLinux_8c.html#a5">TI_open</a>( teleoInterface );
00108   
00109   <span class="comment">// Open the channel</span>
00110   <span class="keywordflow">if</span> ( ( teleoError = <a class="code" href="TeleoChannel_8h.html#a4">TC_Create</a>( &amp;teleoChannel ) ) != <a class="code" href="TeleoError_8h.html#a20a0">TELEO_OK</a> )
00111     <span class="keywordflow">return</span> teleoError;
00112   <a class="code" href="TeleoChannel_8h.html#a11">TC_channelNameSet</a>( teleoChannel, channelName );
00113   <a class="code" href="TeleoChannel_8h.html#a16">TC_sendQueueEnable</a>( teleoChannel, <span class="keyword">true</span> );
00114   
00115   <span class="comment">// set up the channel's system callbacks</span>
00116   <a class="code" href="TeleoChannel_8h.html#a9">TC_outputCallbackSet</a>( teleoChannel, &amp;output );  
00117   <a class="code" href="TeleoChannel_8h.html#a8">TC_timerRequestCallbackSet</a>( teleoChannel, &amp;timerRequest );  
00118   
00119   <span class="comment">// Open the session</span>
00120   <span class="keywordflow">if</span> ( ( teleoError = <a class="code" href="TeleoModuleManager_8h.html#a29">TMM_Create</a>( &amp;teleoModuleManager ) ) != <a class="code" href="TeleoError_8h.html#a20a0">TELEO_OK</a> )
00121     <span class="keywordflow">return</span> teleoError;  
00122   <span class="comment">// Add the channel to the session</span>
00123   <a class="code" href="TeleoModuleManager_8h.html#a32">TMM_channelAdd</a>( teleoModuleManager, teleoChannel );
00124 
00125     
00126   *tmm = <a class="code" href="TeleoModuleLinux_8c.html#a1">teleoModuleManager</a>;
00127   <span class="keywordflow">return</span> <a class="code" href="TeleoError_8h.html#a20a0">TELEO_OK</a>;
00128 }
00129 
<a name="l00130"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a15">00130</a> <span class="keywordtype">void</span> <a class="code" href="TeleoModuleLinux_8c.html#a14">TeleoModule_Start</a>()
00131 {
00132   <span class="comment">// Fire up the input thread</span>
00133   pthread_create( &amp;teleoInputThread, NULL, doInput, NULL );   
00134   <span class="comment">// Fire up the timer thread</span>
00135   pthread_create( &amp;teleoTimerThread, NULL, doTimer, NULL );   
00136   <span class="comment">// Create the mutex</span>
00137   pthread_mutex_init( &amp;teleoThreadMutex, NULL );
00138 }
00139   
<a name="l00140"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a16">00140</a> <span class="keywordtype">void</span> <a class="code" href="TeleoModuleLinux_8c.html#a15">TeleoModule_Continue</a>()
00141 {
00142   pthread_join( teleoInputThread, NULL );
00143   pthread_join( teleoTimerThread, NULL );
00144   pthread_mutex_destroy( &amp;teleoThreadMutex );
00145 }
00146 
00147 
00148 <span class="keywordtype">void</span>* <a class="code" href="TeleoModuleWin32_8c.html#a8">doInput</a>( <span class="keywordtype">void</span> *data )
00149 {  
00150   <a class="code" href="TeleoTypes_8h.html#a3">uint8</a> c;
00151 
00152   <span class="keywordflow">while</span> ( true )
00153   {
00154     <span class="keywordflow">if</span> ( <a class="code" href="TeleoInterfaceLinux_8c.html#a7">TI_get</a>( teleoInterface, &amp;c, 1 ) == <a class="code" href="TeleoError_8h.html#a20a0">TELEO_OK</a> )
00155     {
00156       <a class="code" href="TeleoModuleLinux_8c.html#a16">TeleoModule_Lock</a>( );
00157       <a class="code" href="TeleoChannel_8h.html#a12">TC_input</a>( teleoChannel, c );
00158       <a class="code" href="TeleoModuleLinux_8c.html#a17">TeleoModule_Unlock</a>( );
00159     }
00160   }
00161 }
00162 
00163 <span class="keywordtype">void</span>* <a class="code" href="TeleoChannelTest_8c.html#a5">doTimer</a>( <span class="keywordtype">void</span>* data )
00164 {
00165   <span class="keywordflow">while</span> ( true )
00166   {
00167     <a class="code" href="TeleoModuleLinux_8c.html#a16">TeleoModule_Lock</a>( );
00168     <a class="code" href="TeleoChannel_8h.html#a17">TC_timerEvent</a>( teleoChannel, EVENT_TIME );
00169     <a class="code" href="TeleoModuleManager_8h.html#a46">TMM_timerModuleEvent</a>(teleoModuleManager, EVENT_TIME );
00170     <a class="code" href="TeleoModuleLinux_8c.html#a17">TeleoModule_Unlock</a>();
00171     usleep( EVENT_TIME * 1000 );
00172   }
00173 }
00174 
00175 <a class="code" href="TeleoError_8h.html#a20">TeleoError</a> <a class="code" href="TeleoChannelTest_8c.html#a6">output</a>( <a class="code" href="structTeleoChannel.html">TeleoChannel</a>* tc, uint8* c, uint8 count )
00176 {
00177   <span class="keywordflow">return</span> <a class="code" href="TeleoInterfaceLinux_8c.html#a8">TI_put</a>( teleoInterface, c, count );  
00178 }
00179 
00180 
00181 <a class="code" href="TeleoError_8h.html#a20">TeleoError</a> <a class="code" href="TeleoChannelTest_8c.html#a7">timerRequest</a>( <a class="code" href="structTeleoChannel.html">TeleoChannel</a>* tc, <span class="keywordtype">bool</span> timer )
00182 {
00183   <span class="comment">//printf( "Network Session : Unknown Message Receive\n" );</span>
00184   <span class="keywordflow">return</span> <a class="code" href="TeleoError_8h.html#a20a0">TELEO_OK</a>;
00185 }
00186 
<a name="l00189"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a17">00189</a> <span class="keywordtype">void</span> <a class="code" href="TeleoModuleLinux_8c.html#a16">TeleoModule_Lock</a>()
00190 {
00191   pthread_mutex_lock( &amp;teleoThreadMutex );
00192 }
00193 
<a name="l00196"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a18">00196</a> <span class="keywordtype">void</span> <a class="code" href="TeleoModuleLinux_8c.html#a17">TeleoModule_Unlock</a>()
00197 {
00198   pthread_mutex_unlock( &amp;teleoThreadMutex );
00199 }
00200 
<a name="l00201"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a12">00201</a> <span class="keyword">static</span> <a class="code" href="TeleoError_8h.html#a20">TeleoError</a> <a class="code" href="TeleoModuleMacOSX_8c.html#a12">TI_FindUsbSerialDevice</a>(<span class="keywordtype">char</span>* dest, <span class="keywordtype">int</span> destLen)
00202 {
00203   <span class="keyword">struct </span>dirent **namelist;
00204   <span class="keywordtype">int</span> n;
00205 
00206   n = scandir(<span class="stringliteral">"/dev"</span>, &amp;namelist, matchUsbSerialDevice, NULL);
00207   <span class="keywordflow">if</span> (n &lt; 0)
00208   {
00209     perror(<span class="stringliteral">"scandir"</span>);
00210     <span class="keywordflow">return</span>(TELEO_E_UNKNOWN);
00211   }
00212   <span class="keywordflow">if</span> (n &gt; 1)
00213   {
00214     <span class="comment">// printf("more than one Teleo USB Serial device found, returning first\n");</span>
00215   }
00216   strncpy(dest, namelist[0]-&gt;d_name, destLen);
00217   free(namelist[n]);
00218   free(namelist);
00219   <span class="keywordflow">return</span>(TELEO_OK);
00220 }
00221 
<a name="l00222"></a><a class="code" href="TeleoModuleMacOSX_8c.html#a13">00222</a> <span class="keywordtype">int</span>  <a class="code" href="TeleoModuleMacOSX_8c.html#a13">matchUsbSerialDevice</a> (<span class="keyword">struct</span> dirent * thisun)
00223 {
00224   <span class="keywordflow">if</span> (strncmp(<span class="stringliteral">"tty.usbserial-"</span>, thisun-&gt;d_name, strlen(<span class="stringliteral">"tty.usbserial-"</span>)))
00225     <span class="keywordflow">return</span> 0;
00226   <span class="keywordflow">else</span>
00227     <span class="keywordflow">return</span> 1;
00228 }
</pre></div></font>
<p>&nbsp;</p> 
<table width="100%">
  <tr>
    <td colspan="2" bgcolor="395e7a"> 
      <p align="center"><font color="#FFFFFF" class="small">copyright &copy; 2002, 2003 
        MakingThings LLC</font></p>
    </td>
  </tr>
</table>
 
<p>&nbsp;</p> 
</body>
</html>
