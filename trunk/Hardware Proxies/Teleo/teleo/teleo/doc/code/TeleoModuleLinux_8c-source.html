<html>
<head>
 
<title>TELEO APPLICATION SDK</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="code.css" type="text/css">
</head>

<body bgcolor="#FFFFFF" text="#000000" link="619ec3" vlink="619ec3" alink="619ec3">

<table width="100%" border="0" cellspacing="0" cellpadding="-1">
  <tr> 
    <td width="1%" rowspan="2" bgcolor="#FFFFFF" valign="top"><a href="/index.htm"><img src="images/logo_header_blue.jpg" width="263" height="123" border="0"></a></td>
    <td height="109" bgcolor="395e7a" width="100%" valign="bottom" align="left"> 
      <p>&nbsp;</p>
      <table width="100%" border="0">
        <tr> 
          <td width="20%" height="20" class="medium_bold"> 
            <div align="center">
              <font color="619ec3" class="medium_bold"><a href="http://www.makingthings.com/home.htm">HOME</a></font>
            </div>
          </td>
          <td width="20%" height="20" class="medium_bold"> 
            <div align="center"><font color="619ec3" class="medium_bold"><a href="http://www.makingthings.com/projects.htm">PROJECTS</a></font></div>
          </td>
          <td width="20%" height="20" class="medium_bold"> 
            <div align="center"><font color="#FFFFFF" class="medium_bold"><b class="medium_bold">PRODUCTS</b></font></div>
          </td>
          <td width="20%" class="medium_bold" height="20"> 
            <div align="center"><font color="619ec3" class="medium_bold"><a href="http://www.makingthings.com/services.htm">SERVICES</a></font></div>
          </td>
          <td width="20%" class="medium_bold" height="20"> 
            <div align="center"><font color="619ec3" class="medium_bold"><a href="http://www.makingthings.com/news/news.htm">NEWS</a></font></div>
          </td>
        </tr>
      </table>
    </td>
  </tr>
  <tr> 
    <td width="100%" height="15">&nbsp;</td>
  </tr>
  <tr align="left" valign="middle"> 
    <td colspan="2"></td>
  </tr>
</table> 
<br>
<hr>

<font face="Arial, Helvetica, sans-serif" size="2">


<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>TeleoModuleLinux.c</h1><a href="TeleoModuleLinux_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/* Copyright 2003 MakingThings LLC. */</span>
00002 
00016 <span class="preprocessor">#include "stdio.h"</span>
00017 <span class="preprocessor">#include "<a class="code" href="TeleoModule_8h.html">TeleoModule.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="TeleoModuleManager_8h.html">TeleoModuleManager.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="TeleoInterface_8h.html">TeleoInterface.h</a>"</span>
00020 
00021 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00022 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00023 
<a name="l00024"></a><a class="code" href="TeleoModuleLinux_8c.html#a0">00024</a> <span class="preprocessor">#define EVENT_TIME 10</span>
00025 <span class="preprocessor"></span>
00026 <span class="comment">// Thread stuff</span>
00027 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00028 
00029 <span class="comment">// Locals                            </span>
00033 <span class="comment"></span><span class="keywordtype">void</span>* <a class="code" href="TeleoChannelTest_8c.html#a5">doTimer</a>( <span class="keywordtype">void</span>* data );
00037 <span class="keywordtype">void</span>* <a class="code" href="TeleoModuleWin32_8c.html#a8">doInput</a>( <span class="keywordtype">void</span>* data );
00038 
00039 <span class="comment">// TeleoChannel Callbacks</span>
00043 <span class="comment"></span><a class="code" href="TeleoError_8h.html#a20">TeleoError</a> <a class="code" href="TeleoChannelTest_8c.html#a6">output</a>( <a class="code" href="structTeleoChannel.html">TeleoChannel</a>* tc, uint8* c, uint8 count );
00047 <a class="code" href="TeleoError_8h.html#a20">TeleoError</a> <a class="code" href="TeleoChannelTest_8c.html#a7">timerRequest</a>( <a class="code" href="structTeleoChannel.html">TeleoChannel</a>* tc, <span class="keywordtype">bool</span> enable );
00048 
<a name="l00049"></a><a class="code" href="TeleoModuleLinux_8c.html#a1">00049</a> <a class="code" href="structTeleoModuleManager.html">TeleoModuleManager</a>* <a class="code" href="TeleoModuleLinux_8c.html#a1">teleoModuleManager</a>;
<a name="l00050"></a><a class="code" href="TeleoModuleLinux_8c.html#a2">00050</a> <a class="code" href="structTeleoChannel.html">TeleoChannel</a>* <a class="code" href="TeleoModuleLinux_8c.html#a2">teleoChannel</a>;
<a name="l00051"></a><a class="code" href="TeleoModuleLinux_8c.html#a3">00051</a> <a class="code" href="structTeleoInterface.html">TeleoInterface</a>* <a class="code" href="TeleoModuleLinux_8c.html#a3">teleoInterface</a>;
00052 
00053 <span class="comment">// Threads</span>
<a name="l00054"></a><a class="code" href="TeleoModuleLinux_8c.html#a4">00054</a> pthread_t <a class="code" href="TeleoModuleLinux_8c.html#a4">teleoInputThread</a>;
<a name="l00055"></a><a class="code" href="TeleoModuleLinux_8c.html#a5">00055</a> pthread_t <a class="code" href="TeleoModuleLinux_8c.html#a5">teleoTimerThread</a>;
<a name="l00056"></a><a class="code" href="TeleoModuleLinux_8c.html#a6">00056</a> pthread_mutex_t <a class="code" href="TeleoModuleLinux_8c.html#a6">teleoThreadMutex</a>;
00057 
<a name="l00058"></a><a class="code" href="TeleoModuleLinux_8c.html#a7">00058</a> <span class="keywordtype">bool</span> <a class="code" href="TeleoModuleLinux_8c.html#a7">running</a>;
00059 
<a name="l00060"></a><a class="code" href="TeleoModuleLinux_8c.html#a12">00060</a> <a class="code" href="TeleoError_8h.html#a20">TeleoError</a> <a class="code" href="TeleoModuleLinux_8c.html#a12">TeleoModule_Init</a>( cchar* interfaceName, TI_InterfaceType interfaceType, <a class="code" href="structTeleoModuleManager.html">TeleoModuleManager</a>** tmm )
00061 {
00062   <a class="code" href="TeleoError_8h.html#a20">TeleoError</a> teleoError;
00063   <a class="code" href="TeleoTypes_8h.html#a9">cchar</a>* channelName;
00064 
00065   *tmm = NULL;
00066 
00067   <span class="comment">// Get the interface open</span>
00068   <span class="keywordflow">if</span> ( ( teleoError = <a class="code" href="TeleoInterfaceLinux_8c.html#a0">TI_Create</a>( interfaceName, interfaceType, &amp;teleoInterface ) ) != <a class="code" href="TeleoError_8h.html#a20a0">TELEO_OK</a> )
00069   {
00070        <span class="keywordflow">return</span> teleoError;
00071   }
00072   <a class="code" href="TeleoInterfaceLinux_8c.html#a4">TI_blockingSet</a>( teleoInterface, <span class="keyword">true</span> );
00073   <a class="code" href="TeleoInterfaceLinux_8c.html#a3">TI_typeGet</a>(teleoInterface, &amp;channelName );
00074   <a class="code" href="TeleoInterfaceLinux_8c.html#a5">TI_open</a>( teleoInterface );
00075   
00076   <span class="comment">// Open the channel</span>
00077   <span class="keywordflow">if</span> ( ( teleoError = <a class="code" href="TeleoChannel_8h.html#a4">TC_Create</a>( &amp;teleoChannel ) ) != <a class="code" href="TeleoError_8h.html#a20a0">TELEO_OK</a> )
00078     <span class="keywordflow">return</span> teleoError;
00079   <a class="code" href="TeleoChannel_8h.html#a11">TC_channelNameSet</a>( teleoChannel, channelName );
00080   <a class="code" href="TeleoChannel_8h.html#a16">TC_sendQueueEnable</a>( teleoChannel, <span class="keyword">true</span> );
00081   
00082   <span class="comment">// set up the channel's system callbacks</span>
00083   <a class="code" href="TeleoChannel_8h.html#a9">TC_outputCallbackSet</a>( teleoChannel, &amp;output );  
00084   <a class="code" href="TeleoChannel_8h.html#a8">TC_timerRequestCallbackSet</a>( teleoChannel, &amp;timerRequest );  
00085   
00086   <span class="comment">// Open the session</span>
00087   <span class="keywordflow">if</span> ( ( teleoError = <a class="code" href="TeleoModuleManager_8h.html#a29">TMM_Create</a>( &amp;teleoModuleManager ) ) != <a class="code" href="TeleoError_8h.html#a20a0">TELEO_OK</a> )
00088     <span class="keywordflow">return</span> teleoError;  
00089   <span class="comment">// Add the channel to the session</span>
00090   <a class="code" href="TeleoModuleManager_8h.html#a32">TMM_channelAdd</a>( teleoModuleManager, teleoChannel );
00091 
00092   <a class="code" href="TeleoModuleLinux_8c.html#a7">running</a> = <span class="keyword">false</span>;
00093     
00094   *tmm = <a class="code" href="TeleoModuleLinux_8c.html#a1">teleoModuleManager</a>;
00095   <span class="keywordflow">return</span> <a class="code" href="TeleoError_8h.html#a20a0">TELEO_OK</a>;
00096 }
00097 
<a name="l00098"></a><a class="code" href="TeleoModuleLinux_8c.html#a13">00098</a> <a class="code" href="TeleoError_8h.html#a20">TeleoError</a> <a class="code" href="TeleoModuleLinux_8c.html#a13">TeleoModule_End</a>( )
00099 {
00100   <a class="code" href="TeleoModuleLinux_8c.html#a7">running</a> = <span class="keyword">false</span>;
00101   <a class="code" href="TeleoModuleLinux_8c.html#a15">TeleoModule_Continue</a>( );
00102 
00103   <span class="comment">// take the system down one subsystem at a time</span>
00104   <a class="code" href="TeleoModuleManager_8h.html#a30">TMM_destroy</a>( teleoModuleManager );
00105   <a class="code" href="TeleoChannel_8h.html#a5">TC_destroy</a>( teleoChannel );
00106   <a class="code" href="TeleoInterfaceLinux_8c.html#a1">TI_destroy</a>( teleoInterface );
00107   
00108   <span class="keywordflow">return</span> <a class="code" href="TeleoError_8h.html#a20a0">TELEO_OK</a>;
00109 }
00110 
<a name="l00111"></a><a class="code" href="TeleoModuleLinux_8c.html#a14">00111</a> <span class="keywordtype">void</span> <a class="code" href="TeleoModuleLinux_8c.html#a14">TeleoModule_Start</a>()
00112 {
00113   <a class="code" href="TeleoModuleLinux_8c.html#a7">running</a> = <span class="keyword">true</span>;
00114 
00115   <span class="comment">// Fire up the input thread</span>
00116   pthread_create( &amp;teleoInputThread, NULL, doInput, NULL );   
00117   <span class="comment">// Fire up the timer thread</span>
00118   pthread_create( &amp;teleoTimerThread, NULL, doTimer, NULL );   
00119   <span class="comment">// Create the mutex</span>
00120   pthread_mutex_init( &amp;teleoThreadMutex, NULL );
00121 }
00122   
<a name="l00123"></a><a class="code" href="TeleoModuleLinux_8c.html#a15">00123</a> <span class="keywordtype">void</span> <a class="code" href="TeleoModuleLinux_8c.html#a15">TeleoModule_Continue</a>()
00124 {
00125   pthread_join( teleoInputThread, NULL );
00126   pthread_join( teleoTimerThread, NULL );
00127   pthread_mutex_destroy( &amp;teleoThreadMutex );
00128 }
00129 
00130 
<a name="l00131"></a><a class="code" href="TeleoModuleLinux_8c.html#a9">00131</a> <span class="keywordtype">void</span>* <a class="code" href="TeleoModuleWin32_8c.html#a8">doInput</a>( <span class="keywordtype">void</span> *data )
00132 {  
00133   <a class="code" href="TeleoTypes_8h.html#a3">uint8</a> c;
00134 
00135   <span class="keywordflow">while</span> ( running )
00136   {
00137     <span class="keywordflow">if</span> ( <a class="code" href="TeleoInterfaceLinux_8c.html#a7">TI_get</a>( teleoInterface, &amp;c, 1 ) == <a class="code" href="TeleoError_8h.html#a20a0">TELEO_OK</a> )
00138     {
00139       <a class="code" href="TeleoModuleLinux_8c.html#a16">TeleoModule_Lock</a>( );
00140       <a class="code" href="TeleoChannel_8h.html#a12">TC_input</a>( teleoChannel, c );
00141       <a class="code" href="TeleoModuleLinux_8c.html#a17">TeleoModule_Unlock</a>( );
00142     }
00143   }
00144   pthread_exit( NULL );
00145 }
00146 
<a name="l00147"></a><a class="code" href="TeleoModuleLinux_8c.html#a8">00147</a> <span class="keywordtype">void</span>* <a class="code" href="TeleoChannelTest_8c.html#a5">doTimer</a>( <span class="keywordtype">void</span>* data )
00148 {
00149   <span class="keywordflow">while</span> ( running )
00150   {
00151     <a class="code" href="TeleoModuleLinux_8c.html#a16">TeleoModule_Lock</a>( );
00152     <a class="code" href="TeleoChannel_8h.html#a17">TC_timerEvent</a>( teleoChannel, EVENT_TIME );
00153     <a class="code" href="TeleoModuleManager_8h.html#a46">TMM_timerModuleEvent</a>(teleoModuleManager, EVENT_TIME );
00154     <a class="code" href="TeleoModuleLinux_8c.html#a17">TeleoModule_Unlock</a>();
00155     <a class="code" href="TeleoInterfaceLinux_8c.html#a9">TI_SleepMs</a>( EVENT_TIME );
00156   }
00157   pthread_exit( NULL );
00158 }
00159 
<a name="l00160"></a><a class="code" href="TeleoModuleLinux_8c.html#a10">00160</a> <a class="code" href="TeleoError_8h.html#a20">TeleoError</a> <a class="code" href="TeleoChannelTest_8c.html#a6">output</a>( <a class="code" href="structTeleoChannel.html">TeleoChannel</a>* tc, uint8* c, uint8 count )
00161 {
00162   <span class="keywordflow">return</span> <a class="code" href="TeleoInterfaceLinux_8c.html#a8">TI_put</a>( teleoInterface, c, count );  
00163 }
00164 
00165 
<a name="l00166"></a><a class="code" href="TeleoModuleLinux_8c.html#a11">00166</a> <a class="code" href="TeleoError_8h.html#a20">TeleoError</a> <a class="code" href="TeleoChannelTest_8c.html#a7">timerRequest</a>( <a class="code" href="structTeleoChannel.html">TeleoChannel</a>* tc, <span class="keywordtype">bool</span> timer )
00167 {
00168   <span class="comment">//printf( "Network Session : Unknown Message Receive\n" );</span>
00169   <span class="keywordflow">return</span> <a class="code" href="TeleoError_8h.html#a20a0">TELEO_OK</a>;
00170 }
00171 
<a name="l00174"></a><a class="code" href="TeleoModuleLinux_8c.html#a16">00174</a> <span class="keywordtype">void</span> <a class="code" href="TeleoModuleLinux_8c.html#a16">TeleoModule_Lock</a>()
00175 {
00176   pthread_mutex_lock( &amp;teleoThreadMutex );
00177 }
00178 
<a name="l00181"></a><a class="code" href="TeleoModuleLinux_8c.html#a17">00181</a> <span class="keywordtype">void</span> <a class="code" href="TeleoModuleLinux_8c.html#a17">TeleoModule_Unlock</a>()
00182 {
00183   pthread_mutex_unlock( &amp;teleoThreadMutex );
00184 }
00185 
00186 
</pre></div></font>
<p>&nbsp;</p> 
<table width="100%">
  <tr>
    <td colspan="2" bgcolor="395e7a"> 
      <p align="center"><font color="#FFFFFF" class="small">copyright &copy; 2002, 2003 
        MakingThings LLC</font></p>
    </td>
  </tr>
</table>
 
<p>&nbsp;</p> 
</body>
</html>
